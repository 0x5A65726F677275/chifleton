# Test metrics and report validation

This document describes test coverage and suggested assertions for validating Chifleton report output.

---

## Test coverage

The test suite covers:

- **Parser:** requirements.txt and pyproject.toml parsing; comments, empty lines, version handling.
- **OSV client:** Response handling and query shape (HTTP mocked).
- **Reporter:** Enrichment, HTML structure (summary, footer, overview table), JSON structure and metadata.
- **CLI:** File-not-found, empty file, HTML/JSON output, pyproject.toml scan, end-to-end with mocked OSV.

---

## Suggested test cases for reports

Use these to add or extend tests that assert on report content.

### HTML report

- **Summary present:** HTML contains “Packages scanned:”, “Packages with vulnerabilities:”, “Total vulnerabilities:”.
- **Footer:** Contains “Report generated by Chifleton”, author, and a UTC timestamp; version is present.
- **TOC:** When there are multiple packages, the table of contents has one link per package (e.g. `#pkg-<name>-<version>`).
- **Per-package:** Each package section has vulnerability count; each vulnerability block has at least IDs or “Vulnerability”, and a remediation line.

### JSON report

- **Top-level keys:** `report`, `packages`.
- **`report`:** Contains `generated_at` (ISO 8601), `scanner_version`, `report_author`, `package_count`, `vulnerable_package_count`, `total_vulnerabilities`.
- **`packages`:** Array of objects with `name`, `version`, `vuln_count`, `vulns` (array); each vuln has `id` or `ids`, `summary`, `references`, `remediation`, `severity`.

### CLI end-to-end

- **Exit 0:** `chifleton scan <path>` with a valid requirements file exits 0 (no missing file or crash).
- **Exit 1:** `chifleton scan /nonexistent/path` exits 1 and prints an error.
- **Output files:** After `chifleton scan <path> --report html`, `scan-report.html` exists next to the scanned file; after `--report json`, `scan-report.json` exists.
- **JSON + HTML both:** Running with `--report html` then `--report json` (or vice versa) produces both files with consistent package/vuln counts.
